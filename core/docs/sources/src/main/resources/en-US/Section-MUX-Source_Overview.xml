<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [<!ENTITY % BOOK_ENTITIES SYSTEM "User_Guide.ent">%BOOK_ENTITIES;]>

<section id="mux-source_overview">

	<title>&THIS.PLATFORM; Diameter Multiplexer (MUX) Source Overview</title>

	<para>&THIS.PLATFORM; Diameter MUX capabilities are defined by a MBean interface: <classname>org.mobicents.diameter.stack.DiameterStackMultiplexerMBean</classname>. This interface defines two types of methods:</para>
	<variablelist>
		<varlistentry>
			<term>Management</term>
			<listitem>
				<para>Used by &MANAGEMENT.PLATFORM; console, those methods are out of scope for user.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>Stack accessors</term>
			<listitem>
				<para>Methods which allow retrieval and usage of wrapped stack.</para>
			</listitem>
		</varlistentry>
	</variablelist>
	<para> The following methods are of interest to &THIS.PLATFORM; Diameter MUX user:</para>
	<variablelist>
		<varlistentry>
			<term><methodname>public Stack getStack();</methodname></term>
			<listitem>
				<para>Returns the stack instance wrapped by multiplexer. It's present as a convenience method, and stack should only be changed directly by expert users.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term><methodname>public void registerListener(DiameterListener listener, ApplicationId[] appIds) throws IllegalStateException;</methodname></term>
			<listitem>
				<para>Method for registering a Diameter listener, to be triggered when a message for certain application id is received.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term><methodname>public void unregisterListener(DiameterListener listener);</methodname></term>
			<listitem>
				<para>Method for unregistering a Diameter listener, for all its applications.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term><methodname>public DiameterStackMultiplexerMBean getMultiplexerMBean();</methodname></term>
			<listitem>
				<para>Returns the actual instance of <acronym>MUX</acronym>.</para>
			</listitem>
		</varlistentry>
		
	</variablelist>
	<para>Listener interface is defined as follows: </para>
	<programlisting role="JAVA" language="Java">
package org.mobicents.diameter.stack;

import java.io.Serializable;

import org.jdiameter.api.Answer;
import org.jdiameter.api.EventListener;
import org.jdiameter.api.NetworkReqListener;
import org.jdiameter.api.Request;

public interface DiameterListener extends NetworkReqListener, Serializable, 
	EventListener&lt;Request, Answer&gt;
{

}
	</programlisting>
	<para><acronym>MUX</acronym> can be used as follows:</para>
	<programlisting role="JAVA" language="Java">public class DiameterActor implements DiameterListener
{
	private ObjectName diameterMultiplexerObjectName = null;
	private DiameterStackMultiplexerMBean diameterMux = null;

	private synchronized void initStack() throws Exception {
		this.diameterMultiplexerObjectName = 
			new ObjectName("diameter.mobicents:service=DiameterStackMultiplexer");

		Object[] params = new Object[]{};
		String[] signature = new String[]{};

		String operation = "getMultiplexerMBean";
		this.diameterMux=mbeanServer.invoke(this.diameterMultiplexerObjectName, operation,
			params, signature);

		long acctAppIds = new long[]{19312L};
		long acctVendorIds = new long[]{193L};
		long authAppIds = new long[]{4L};
		long authVendorIds = new long[]{0L};
		List&lt;ApplicationId&gt; appIds = new ArrayList&lt;ApplicationId&gt;();
		for(int index = 0;index&lt;acctAppIds.length;index++) {
			appIds.add(ApplicationId.createByAccAppId(acctVendorIds[index], acctAppIds[index]));
		}

		for(int index = 0;index&lt;authAppIds.length;index++) {
			appIds.add(ApplicationId.createByAuthAppId(authVendorIds[index], authAppIds[index]));
		}

		this.diameterMux.registerListener(this, appIds.toArray(new ApplicationId[appIds.size()]));
		this.stack = this.diameterMux.getStack();
		this.messageTimeout = stack.getMetaData().getConfiguration().getLongValue(
			MessageTimeOut.ordinal(), (Long) MessageTimeOut.defValue());
	}
}</programlisting>

</section>
