<?xml version='1.0'?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [<!ENTITY % BOOK_ENTITIES SYSTEM "User_Guide.ent">%BOOK_ENTITIES;]>

<section id="jdiameter-configuration">

	<title>&THIS.PLATFORM; Diameter Stack Configuration</title>

	<para>The stack is initially configured by parsing an XML file. The top level structure of the file is described below. Further explanation of each child element, and the applicable attributes is provided later in this section.</para>
	<programlisting language="XML" role="XML"><![CDATA[<Configuration xmlns="http://www.jdiameter.org/jdiameter-server">

	<LocalPeer></LocalPeer>
	<Parameters></Parameters>
	<Network></Network>
	<Extensions></Extensions>

</Configuration>]]></programlisting>

	<programlisting role="XML"><![CDATA[<LocalPeer>
	<URI value="aaa://localhost:1812"/>
	<IPAddresses>
		<IPAddress value="127.0.0.1"/>
	</IPAddresses>

	<Realm value="mobicents.org"/>
	<VendorID value="193"/>
	<ProductName value="jDiameter"/>
	<FirmwareRevision value="1"/>

	<OverloadMonitor>
		<Entry index="1" lowThreshold="0.5" highThreshold="0.6">
			<ApplicationID>
				<VendorId value="193"/>
				<AuthApplId value="0"/>
				<AcctApplId value="19302"/>
			</ApplicationID>
		</Entry>
	</OverloadMonitor>
	<Applications>
		<ApplicationID>
			<VendorId value="193"/>
			<AuthApplId value="0"/>
			<AcctApplId value="19302"/>
		</ApplicationID>
	</Applications>
</LocalPeer>]]></programlisting>

	<para>The &lt;LocalPeer&gt; element contains parameters which affect the local Diameter peer. The available elements and attributes are listed for reference.</para>
	<variablelist>
		<title>&lt;LocalPeer&gt; Elements and Attributes</title>
		<varlistentry>
			<term>&lt;URI&gt;</term>
			<listitem>
				<para>Specifies the URI for the local peer. URI has following format: &quot;aaa://FQDN:port&quot;.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;IPAddresses&gt;</term>
			<listitem>
				<para>Contains one or more child &lt;IPAddress&gt; elements which contain a single, valid IP address for the local peer, stored in the <parameter>value</parameter> attribute of IPAddress.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Realm&gt;</term>
			<listitem>
				<para>Specifies the realm of the local peer, using the <parameter>value</parameter> attribute.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;VendorID&gt;</term>
			<listitem>
				<para>Specifies a numeric identifier that corresponds to the vendor ID allocated by IANA. </para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;ProductName&gt;</term>
			<listitem>
				<para>Specifies the name of the local peer product name.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;FirmwareRevision&gt;</term>
			<listitem>
				<para>Specifies the version of the firmware.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;OverloadMonitor&gt;</term>
			<listitem>
				<para>Optional parent element containing child elements which specify settings relating to the Overload Monitor.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Entry&gt;</term>
			<listitem>
				<para>Supports child elements of type &lt;ApplicationID&gt;, which specify the id of the tracked application(s). It also supports following properties:
					<variablelist>
						<varlistentry>
							<term>index</term>
							<listitem>
								<para>Defines the index of this overload monitor, so priorities/orders can be specified.</para>
							</listitem>
						</varlistentry>
						<varlistentry>
							<term>lowThreshold</term>
							<listitem>
								<para>The low threshold for activation of the overload monitor.</para>
							</listitem>
						</varlistentry>
						<varlistentry>
							<term>highThreshold</term>
							<listitem>
								<para>The high threshold for activation of the overload monitor.</para>
							</listitem>
						</varlistentry>
					</variablelist>
				</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;ApplicationID&gt;</term>
			<listitem>
				<para>Parent element containing child elements which specify information about the application. Child elements are: VendorId, AuthAppId and AcctAppId. Together they create an unique application identifier.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;VendorId&gt;</term>
			<listitem>
				<para>Specifies vendor id for application definition. It supports a single property: &quot;value&quot;</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;AuthAppId&gt;</term>
			<listitem>
				<para>The Authentication Application ID for application definition. It supports a single property: &quot;value&quot;</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;AcctAplId&gt;</term>
			<listitem>
				<para>The Account Application ID for application defitniion. It supports a single property: &quot;value&quot;</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Applications&gt;</term>
			<listitem>
				<para>Contains a child element &lt;ApplicationID&gt;, which defines the list of default supported applications. It is used for server side. When stack is configured to accept incoming calls and there is empty list of preconfigured peers (server is configured to accept any connection).</para>
			</listitem>
		</varlistentry>
	</variablelist>
	<programlisting role="XML"><![CDATA[<Parameters>

	<AcceptUndefinedPeer value="true"/>
	<DuplicateProtection value="true"/>
	<DuplicateTimer value="240000"/>
	<UseUriAsFqdn value="true"/> <!-- Needed for Ericsson SDK Emulator -->
	<QueueSize value="10000"/>
	<MessageTimeOut value="60000"/>
	<StopTimeOut value="10000"/>
	<CeaTimeOut value="10000"/>
	<IacTimeOut value="30000"/>
	<DwaTimeOut value="10000"/>
	<DpaTimeOut value="5000"/>
	<RecTimeOut value="10000"/>

	<Concurrent>
		<Entity name="ThreadGroup" size="64"/>
		<Entity name="ProcessingMessageTimer" size="1"/>
		<Entity name="DuplicationMessageTimer" size="1"/>
		<Entity name="RedirectMessageTimer" size="1"/>
		<Entity name="PeerOverloadTimer" size="1"/>
		<Entity name="ConnectionTimer" size="1"/>
		<Entity name="StatisticTimer" size="1"/>
		<Entity name="ApplicationSession" size="16"/>
	</Concurrent>

</Parameters>]]></programlisting>

	<para>The &lt;Parameters&gt; element contains elements which specify parameters for the Diameter stack. The available elements and attributes are listed for reference. If not specified otherwise each tag supports a single property &quot;value&quot; which indicates value of tag.</para>
	<!--TODO: Developer: Need to obtain better definitions for the Parameter Elements and Attributes. Information present at the moment is not that helpful to readers.-->
	<variablelist>
		<title>&lt;Parameters&gt; Elements and Attributes</title>
		<varlistentry>
			<term>&lt;AcceptUndefinedPeer&gt;</term>
			<listitem>
				<para> Specifies whether the stack will accept connections from undefined peers. The default value is <literal>false</literal>.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;DuplicateProtection&gt;</term>
			<listitem>
				<para> Specifies whether duplicate message protection is enabled. The default value is <literal>false</literal>.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;DuplicateTimer&gt;</term>
			<listitem>
				<para> Specifies the time each duplicate message is valid for. The default, minimum value is <literal>240000</literal> (4 minutes in milliseconds)</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;UseUriAsFqdn&gt;</term>
			<listitem>
				<para> Determines as URI should be used as FQDN, if set to <literal>true</literal> stack expects destination/origin host in format of &quot;aaa://isdn.domain.com:3868&quot; instead of proper &quot;isdn.domain.com&quot;. Default value is <literal>false</literal>.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;QueueSize&gt;</term>
			<listitem>
				<para> Determines how many tasks peer state machine can have before rejecting next task. This queue contains FSM event and messaging.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;MessageTimeOut&gt;</term>
			<listitem>
				<para>Determines timeout for other than protocol FSM messages. Delay is in milliseconds.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;StopTimeOut&gt;</term>
			<listitem>
				<para>Determines how long stack waits for all resources to stop gracefully. Delays is in milliseconds.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;CeaTimeOut&gt;</term>
			<listitem>
				<para>Determines how long it takes for CER/CEA exchange to timeout if there is no response. Delay is in milliseconds.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;IacTimeOut&gt;</term>
			<listitem>
				<para>Determines how long to retry communication with a peer that stopped answering DWR messages. The delay is in milliseconds</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;DwaTimeOut&gt;</term>
			<listitem>
				<para>Determines how long it takes for DWR/DWA exchange to timeout if there is no response. Delay is in milliseconds.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;DpaTimeOut&gt;</term>
			<listitem>
				<para>Determines how long it takes for DPR/DPA exchange to timeout if there is no response. Delay is in milliseconds.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;RecTimeOut&gt;</term>
			<listitem>
				<para> Determines how long it takes for reconnection procedure to timeout. Delay is in milliseconds.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Concurrent /&gt;</term>
			<listitem>
				<para>Controls thread pool sizes for different aspects of stack. Supports multiple <parameter>Entity</parameter> child elements. <parameter>Entity</parameter> elements configure thread groups</para>
				<para>Entity element supports following properties:</para>
			<variablelist>
				<varlistentry>
					<term>name</term>
					<listitem>
						<para>Specifies the name of the entity.</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>size</term>
				<listitem>
					<para>Thread pool size of entity.</para>
				</listitem>
				</varlistentry>
			</variablelist>
			<para>Default supported entities are as follows:</para>
			<variablelist>
				<varlistentry>
					<term>ThreadGroup</term>
					<listitem>
						<para>Specifies maximum thread count in other entities</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>ProcessingMessageTimer</term>
					<listitem>
						<para>Specifies thread count for message processing task.</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>DuplicationMessageTimer</term>
					<listitem>
						<para>Specifies thread pool for identifying duplicate messages.</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>RedirectMessageTimer</term>
					<listitem>
						<para>Specifies thread pool for redirecting messages, which do not need any further processing (ie, relaying).</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>PeerOverloadTimer</term>
					<listitem>
						<para>Specifies thread pool for overload monitor tasks.</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>ConnectionTimer</term>
					<listitem>
						<para>Specifies thread pool for managing tasks regarding peer connection <acronym>FSM</acronym>.</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>StatisticTimer</term>
					<listitem>
						<para>Specifies thread pool for statistic gathering tasks.</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>ApplicationSession</term>
					<listitem>
						<para>Specifies thread pool for managing invocation of application session <acronym>FSM</acronym>, which will invoke listeners.</para>
					</listitem>
				</varlistentry>
			</variablelist>
	</listitem>
		</varlistentry>
	</variablelist>
	
	<programlisting role="XML"><![CDATA[<Network>

	<Peers>
		<!-- This peer is a server, if it's a client attempt_connect should be set to false -->
		<Peer name="aaa://127.0.0.1:3868" attempt_connect="true" rating="1"/>
	</Peers>

	<Realms>
		<Realm name="mobicents.org" peers="127.0.0.1" local_action="LOCAL" dynamic="false" exp_time="1">
			<ApplicationID>
				<VendorId value="193"/>
				<AuthApplId value="0"/>
				<AcctApplId value="19302"/>
			</ApplicationID>
		</Realm>
	</Realms>

</Network>]]></programlisting>

	<para>The &lt;Network&gt; element contains elements which specify parameters for external peers. The available elements and attributes are listed for reference.</para>
	<variablelist>
		<title>&lt;Network&gt; Elements and Attributes</title>
		<varlistentry>
			<term>&lt;Peers&gt;</term>
			<listitem>
				<para>Parent element containing child elements which specify external peers and the way they connect.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Peer&gt;</term>
			<listitem>
				<para>Specifies the name of the external peer, whether the peer should be treated as a server or client, and what rating the peer has externally.</para>
				<para>Peer supports following properties:<variablelist>
						<varlistentry>
							<term>name</term>
							<listitem>
								<para>Specifies name of peer in for of URI. structure looks as follows &quot;aaa://[fqdn|ip]:port&quot;, for example &quot;aaa://192.168.1.1:3868&quot;</para>
							</listitem>
						</varlistentry>
						<varlistentry>
							<term>attempt_connect</term>
							<listitem>
								<para>Determines if stack should try to connect to this peer. This property accepts boolean values.</para>
							</listitem>
						</varlistentry>
						<varlistentry>
							<term>rating</term>
							<listitem>
								<para>Specifies the rating of this peer, in order to achiever peer priorities/sorting.</para>
							</listitem>
						</varlistentry>
					</variablelist>
				</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Realms&gt;</term>
			<listitem>
				<para>Parent element containing child elements which specify all realms that connect into the Diameter network.</para>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>&lt;Realm&gt;</term>
			<listitem>
				<para>Child element containing attributes and elements which describe different realms configured for the Core. It supports &lt;ApplicationID&gt; child elements, which define applications supported. </para>
				<para>Realm supports following parameters:</para>
				<variablelist>
					<varlistentry>
						<term>peers</term>
						<listitem>
							<para>Comma separated list of peers, each peer is represented by IP Address or FQDN.</para>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>local_action</term>
						<listitem>
							<para>Determines the action the Local Peer will play on the specified realm: Act as a LOCAL peer</para>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>dynamic</term>
						<listitem>
							<para>Specifies if this realm is dynamic, ie, peers connecting to local peer with this realm name, will be added to the realm peer list if not present already.</para>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>exp_time</term>
						<listitem>
							<para>The expire time for a peer belonging to this realm to be removed from it, if no connection is available.</para>
						</listitem>
					</varlistentry>
				</variablelist>
			</listitem>
		</varlistentry>
	</variablelist>
 	<para>An example configuration file for a server supporting the CCA, Sh and Ro Applications: </para>
 	<programlisting language="XML" role="XML"><![CDATA[<?xml version="1.0"?>
<Configuration xmlns="http://www.jdiameter.org/jdiameter-server">

	<LocalPeer>
		<URI value="aaa://127.0.0.1:3868" />
		<Realm value="mobicents.org" />
		<VendorID value="193" />
		<ProductName value="jDiameter" />
		<FirmwareRevision value="1" />
		<OverloadMonitor>
			<Entry index="1" lowThreshold="0.5" highThreshold="0.6">
				<ApplicationID>
					<VendorId value="193" />
					<AuthApplId value="0" />
					<AcctApplId value="19302" />
				</ApplicationID>
			</Entry>
		</OverloadMonitor>
	</LocalPeer>

	<Parameters>
		<AcceptUndefinedPeer value="true" />
		<DuplicateProtection value="true" />
		<DuplicateTimer value="240000" />
		<UseUriAsFqdn value="false" /> <!-- Needed for Ericsson Emulator (set to true) -->
		<QueueSize value="10000" />
		<MessageTimeOut value="60000" />
		<StopTimeOut value="10000" />
		<CeaTimeOut value="10000" />
		<IacTimeOut value="30000" />
		<DwaTimeOut value="10000" />
		<DpaTimeOut value="5000" />
		<RecTimeOut value="10000" />
		<Concurrent>
			 <Entity name="ThreadGroup" size="64"/>
			 <Entity name="ProcessingMessageTimer" size="1"/>
			 <Entity name="DuplicationMessageTimer" size="1"/>
			 <Entity name="RedirectMessageTimer" size="1"/>
			 <Entity name="PeerOverloadTimer" size="1"/>
			 <Entity name="ConnectionTimer" size="1"/>
			 <Entity name="StatisticTimer" size="1"/>
			 <Entity name="ApplicationSession" size="16"/>
		</Concurrent>
	</Parameters>

	<Network>
		<Peers>
			<Peer name="aaa://127.0.0.1:1218" attempt_connect="false" rating="1" />
		</Peers>
		<Realms>
			<!-- CCA -->
			<Realm name="mobicents.org" peers="127.0.0.1" local_action="LOCAL" 
				dynamic="false" exp_time="1">
				<ApplicationID>
					<VendorId value="0" />
					<AuthApplId value="4" />
					<AcctApplId value="0" />
				</ApplicationID>
			</Realm>
			
			<!-- Sh -->
			<Realm name="mobicents.org" peers="127.0.0.1" local_action="LOCAL" 
				dynamic="false" exp_time="1">
				<ApplicationID>
					<VendorId value="10415" />
					<AuthApplId value="16777217" />
					<AcctApplId value="0" />
				</ApplicationID>
			</Realm>

			<!-- Ro -->
			<Realm name="mobicents.org" peers="127.0.0.1" local_action="LOCAL" 
				dynamic="false" exp_time="1">
				<ApplicationID>
					<VendorId value="10415" />
					<AuthApplId value="4" />
					<AcctApplId value="0" />
				</ApplicationID>
			</Realm>
		</Realms>
	</Network>

	<Extensions />

</Configuration>]]></programlisting>

	<section id="jdiameter-cluster-configuration">
		<title>Cluster configuration</title>
		<para>To enable stack clsuter mode you need following: </para>
		<itemizedlist>
			<listitem>	
				<para>
					Add the following entries in <literal>Parameters</literal> section of <filename>jdiameter-config.xml</filename>:
				</para>
				<programlisting lang="XML" role="XML">
				<![CDATA[
<SessionDatasource>org.mobicents.diameter.impl. ha.data.ReplicatedData</SessionDatasource>
<TimerFacility>org.mobicents.diameter.impl.ha. timer.ReplicatedTimerFacilityImpl</TimerFacility>
				]]>
				</programlisting>
			</listitem>
			<listitem>
				<para>Proper <literal>JBoss Cache</literal> configuration file: <filename>jdiameter-jbc.xml</filename> (located under <filename>config</filename> directory). For instance following content is enough:</para>
				<programlisting lang="XML" role="XML">
				<![CDATA[
<?xml version="1.0" encoding="UTF-8"?>

<jbosscache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns="urn:jboss:jbosscache-core:config:3.0">

	<locking isolationLevel="REPEATABLE_READ"
		lockParentForChildInsertRemove="false" lockAcquisitionTimeout="20000"
		nodeLockingScheme="mvcc" writeSkewCheck="false" concurrencyLevel="500" />

	<jmxStatistics enabled="false" />

	<startup regionsInactiveOnStartup="false" />
	<shutdown hookBehavior="DEFAULT" />
	<listeners asyncPoolSize="1" asyncQueueSize="100000" />

	<invocationBatching enabled="false" />

	<serialization objectInputStreamPoolSize="12"
		objectOutputStreamPoolSize="14" version="3.0.0"
		marshallerClass="org.jboss.cache.marshall.CacheMarshaller300"
		useLazyDeserialization="false" useRegionBasedMarshalling="false" />

	<clustering mode="replication" clusterName="DiameterCluster">

		<async useReplQueue="true" replQueueInterval="1000"
			replQueueMaxElements="500" serializationExecutorPoolSize="20"
			serializationExecutorQueueSize="5000000"/>

		<jgroupsConfig>
			<UDP
				mcast_addr="${jgroups.udp.mcast_addr:228.10.10.10}"
				mcast_port="${jgroups.udp.mcast_port:18811}"
				discard_incompatible_packets="true"
				max_bundle_size="60000"
				max_bundle_timeout="30"
				ip_ttl="${jgroups.udp.ip_ttl:2}"
				enable_bundling="true"
				thread_pool.enabled="true"
				thread_pool.min_threads="1"
				thread_pool.max_threads="25"
				thread_pool.keep_alive_time="5000"
				thread_pool.queue_enabled="false"
				thread_pool.queue_max_size="100"
				thread_pool.rejection_policy="Run"
				oob_thread_pool.enabled="true"
				oob_thread_pool.min_threads="1"
				oob_thread_pool.max_threads="8"
				oob_thread_pool.keep_alive_time="5000"
				oob_thread_pool.queue_enabled="false"
				oob_thread_pool.queue_max_size="100"
				oob_thread_pool.rejection_policy="Run"/>

			<PING timeout="2000"
				num_initial_members="3"/>
			<MERGE2 max_interval="30000"
				min_interval="10000"/>
			<FD_SOCK/>
			<FD timeout="10000" max_tries="5" />
			<VERIFY_SUSPECT timeout="1500"  />
			<BARRIER />
			<pbcast.NAKACK
				use_mcast_xmit="false" gc_lag="0"
				retransmit_timeout="300,600,1200,2400,4800"
				discard_delivered_msgs="true"/>
			<UNICAST timeout="300,600,1200,2400,3600"/>
			<pbcast.STABLE stability_delay="1000" desired_avg_gossip="50000"
				max_bytes="400000"/>
			<VIEW_SYNC avg_send_interval="60000"   />
			<pbcast.GMS print_local_addr="true" join_timeout="3000"
				view_bundling="true"/>
			<FC max_credits="20000000"
				min_threshold="0.10"/>
			<FRAG2 frag_size="60000"  />
			<pbcast.STATE_TRANSFER  />
		</jgroupsConfig>
	</clustering>

</jbosscache>
				]]>
				</programlisting>
			</listitem>
		</itemizedlist>
		
	</section>
</section>
